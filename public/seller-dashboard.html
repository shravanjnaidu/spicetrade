<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Seller Dashboard — spicetrade</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .seller-container {
        max-width: 1200px;
        margin: 28px auto;
        padding: 0 16px;
        flex: 1 0 auto;
      }
      .dashboard-header {
        margin-bottom: 24px;
      }
      .dashboard-header h1 {
        font-size: 32px;
        margin: 0 0 8px 0;
      }
      .dashboard-header p {
        color: var(--muted);
        margin: 0;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }
      @media (min-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      .card-section {
        background: #fff;
        border: 1px solid #f2f2f2;
        padding: 20px;
        border-radius: 8px;
      }
      .card-section h2 {
        font-size: 20px;
        margin: 0 0 16px 0;
        color: #222;
      }
      .store-info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
      }
      .store-info-row:last-child {
        border-bottom: none;
      }
      .store-info-label {
        font-weight: 600;
        color: #555;
      }
      .store-info-value {
        color: #222;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 16px;
        flex-wrap: wrap;
      }
      .product-list {
        margin-top: 16px;
      }
      .product-item {
        padding: 12px;
        background: #fafafa;
        border: 1px solid #e9e9e9;
        border-radius: 6px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .product-item h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
      }
      .product-item p {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
      }
      .product-actions {
        display: flex;
        gap: 8px;
      }
      .btn-small {
        padding: 6px 10px;
        font-size: 14px;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted);
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-header h3 {
        margin: 0;
      }
      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #e6e6e6;
        border-radius: 6px;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <a href="/"><img src="/logo.svg" alt="spicetrade logo" class="logo" /></a>
      <div class="header-right"></div>
    </header>

    <main class="seller-container">
      <div class="dashboard-header">
        <h1>Seller Dashboard</h1>
        <p>Manage your store, products and services</p>
      </div>

      <div class="dashboard-grid">
        <!-- Store Details Card -->
        <div class="card-section">
          <h2>Store Details</h2>
          <div id="storeDetails">
            <div class="store-info-row">
              <span class="store-info-label">Store Name:</span>
              <span class="store-info-value" id="storeName">—</span>
            </div>
            <div class="store-info-row">
              <span class="store-info-label">Business Type:</span>
              <span class="store-info-value" id="businessType">—</span>
            </div>
            <div class="store-info-row">
              <span class="store-info-label">Email:</span>
              <span class="store-info-value" id="storeEmail">—</span>
            </div>
            <div class="store-info-row">
              <span class="store-info-label">Category:</span>
              <span class="store-info-value" id="storeCategory">—</span>
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn" onclick="editStoreDetails()">
              Edit Store Details
            </button>
          </div>
        </div>

        <!-- Quick Stats Card -->
        <div class="card-section">
          <h2>Quick Stats</h2>
          <div class="store-info-row">
            <span class="store-info-label">Total Products:</span>
            <span class="store-info-value" id="totalProducts">0</span>
          </div>
          <div class="store-info-row">
            <span class="store-info-label">Total Services:</span>
            <span class="store-info-value" id="totalServices">0</span>
          </div>
          <div class="store-info-row">
            <span class="store-info-label">Member Since:</span>
            <span class="store-info-value" id="memberSince">—</span>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div class="card-section" style="margin-top: 20px">
        <h2>Products</h2>
        <div class="action-buttons">
          <button class="btn" onclick="openProductModal()">Add Product</button>
        </div>
        <div class="product-list" id="productsList">
          <div class="empty-state">
            No products added yet. Click "Add Product" to get started.
          </div>
        </div>
      </div>

      <!-- Services Section -->
      <div class="card-section" style="margin-top: 20px">
        <h2>Services</h2>
        <div class="action-buttons">
          <button class="btn" onclick="openServiceModal()">Add Service</button>
        </div>
        <div class="product-list" id="servicesList">
          <div class="empty-state">
            No services added yet. Click "Add Service" to get started.
          </div>
        </div>
      </div>
    </main>

    <!-- Add Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Product</h3>
          <button class="close-modal" onclick="closeProductModal()">
            &times;
          </button>
        </div>
        <form id="productForm">
          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input type="text" id="productName" name="name" required />
          </div>
          <div class="form-group">
            <label for="productDescription">Description *</label>
            <textarea
              id="productDescription"
              name="description"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="productPrice">Price *</label>
            <input
              type="number"
              id="productPrice"
              name="price"
              step="0.01"
              required
            />
          </div>
          <div class="form-group">
            <label for="productCategory">Category *</label>
            <select id="productCategory" name="category" required>
              <option value="">Select category</option>
              <option value="Spices">Spices</option>
              <option value="Grains">Grains</option>
              <option value="Packaging">Packaging</option>
              <option value="Machinery">Machinery</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group" id="productTagsGroup" style="display: none">
            <label>Select Tag *</label>
            <select
              id="productTagsDropdown"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #e6e6e6;
                border-radius: 6px;
              "
            >
              <option value="">Select a tag</option>
            </select>
            <div
              id="productSelectedTagsContainer"
              style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px"
            ></div>
          </div>
          <div class="form-group">
            <label for="productImage">Product Image</label>
            <input
              type="file"
              id="productImage"
              name="image"
              accept="image/*"
            />
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn">Add Product</button>
            <button
              type="button"
              class="btn secondary"
              onclick="closeProductModal()"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Service Modal -->
    <div id="serviceModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Service</h3>
          <button class="close-modal" onclick="closeServiceModal()">
            &times;
          </button>
        </div>
        <form id="serviceForm">
          <div class="form-group">
            <label for="serviceName">Service Name *</label>
            <input type="text" id="serviceName" name="name" required />
          </div>
          <div class="form-group">
            <label for="serviceDescription">Description *</label>
            <textarea
              id="serviceDescription"
              name="description"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="servicePrice">Starting Price *</label>
            <input
              type="number"
              id="servicePrice"
              name="price"
              step="0.01"
              required
            />
          </div>
          <div class="form-group">
            <label for="serviceCategory">Category *</label>
            <select id="serviceCategory" name="category" required>
              <option value="">Select category</option>
              <option value="Consulting">Consulting</option>
              <option value="Logistics">Logistics</option>
              <option value="Maintenance">Maintenance</option>
              <option value="Installation">Installation</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group" id="serviceTagsGroup" style="display: none">
            <label>Select Tag *</label>
            <select
              id="serviceTagsDropdown"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #e6e6e6;
                border-radius: 6px;
              "
            >
              <option value="">Select a tag</option>
            </select>
            <div
              id="serviceSelectedTagsContainer"
              style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px"
            ></div>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn">Add Service</button>
            <button
              type="button"
              class="btn secondary"
              onclick="closeServiceModal()"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer class="footer">
      <p>&copy; 2025 SpiceTrade. All rights reserved.</p>
    </footer>

    <script src="/app.js"></script>
    <script>
      // Load store details from localStorage
      const user = JSON.parse(
        localStorage.getItem("spicetrade_user") || "null"
      );

      if (!user || user.role !== "seller") {
        // redirect if not a seller
        alert("Access denied. Please sign up as a seller.");
        location.href = "/signup.html?role=seller";
      }

      // Populate store details
      document.getElementById("storeName").textContent =
        user.storeName || "Not set";
      document.getElementById("storeEmail").textContent = user.email || "—";
      document.getElementById("businessType").textContent = "Seller"; // Could be enhanced
      document.getElementById("storeCategory").textContent = "General"; // Could be enhanced
      document.getElementById("memberSince").textContent =
        new Date().toLocaleDateString();

      // Load products/services from database
      let products = [];
      let services = [];

      function updateStats() {
        document.getElementById("totalProducts").textContent = products.length;
        document.getElementById("totalServices").textContent = services.length;
      }

      // Load products and services from database
      function loadProductsFromDB() {
        fetch("/api/ads")
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              // Filter ads by current user and separate products from services
              const userAds = data.ads.filter(
                (ad) => ad.userId === user.id && ad.price
              );
              products = userAds.filter((ad) => ad.unit !== "service");
              services = userAds.filter((ad) => ad.unit === "service");

              renderProducts();
              renderServices();
              updateStats();
            }
          })
          .catch((err) => {
            console.error("Failed to load products:", err);
          });
      }

      function renderProducts() {
        const list = document.getElementById("productsList");
        if (products.length === 0) {
          list.innerHTML =
            '<div class="empty-state">No products added yet. Click "Add Product" to get started.</div>';
          return;
        }
        list.innerHTML = "";
        products.forEach((p, index) => {
          const item = document.createElement("div");
          item.className = "product-item";
          const tags =
            typeof p.tags === "string"
              ? JSON.parse(p.tags || "[]")
              : p.tags || [];
          const tagsHtml =
            tags.length > 0
              ? `<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">${tags
                  .map(
                    (tag) =>
                      `<span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 12px; color: #555; text-transform: lowercase;">${escapeHtml(
                        tag
                      )}</span>`
                  )
                  .join("")}</div>`
              : "";
          item.innerHTML = `
            <div>
              <h4>${escapeHtml(p.title || p.name)}</h4>
              <p>${escapeHtml(p.description)} • $${p.price}</p>
              ${tagsHtml}
            </div>
            <div class="product-actions">
              <button class="btn btn-small secondary" onclick="editProduct(${
                p.id
              })">Edit</button>
              <button class="btn btn-small secondary" onclick="deleteProduct(${
                p.id
              })">Delete</button>
            </div>
          `;
          list.appendChild(item);
        });
      }

      function renderServices() {
        const list = document.getElementById("servicesList");
        if (services.length === 0) {
          list.innerHTML =
            '<div class="empty-state">No services added yet. Click "Add Service" to get started.</div>';
          return;
        }
        list.innerHTML = "";
        services.forEach((s, index) => {
          const item = document.createElement("div");
          item.className = "product-item";
          const tags =
            typeof s.tags === "string"
              ? JSON.parse(s.tags || "[]")
              : s.tags || [];
          const tagsHtml =
            tags.length > 0
              ? `<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">${tags
                  .map(
                    (tag) =>
                      `<span style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-size: 12px; color: #555; text-transform: lowercase;">${escapeHtml(
                        tag
                      )}</span>`
                  )
                  .join("")}</div>`
              : "";
          item.innerHTML = `
            <div>
              <h4>${escapeHtml(s.title || s.name)}</h4>
              <p>${escapeHtml(s.description)} • Starting at $${s.price}</p>
              ${tagsHtml}
            </div>
            <div class="product-actions">
              <button class="btn btn-small secondary" onclick="editService(${
                s.id
              })">Edit</button>
              <button class="btn btn-small secondary" onclick="deleteService(${
                s.id
              })">Delete</button>
            </div>
          `;
          list.appendChild(item);
        });
      }

      function escapeHtml(s) {
        if (!s) return "";
        return s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function openProductModal() {
        document.getElementById("productModal").classList.add("active");
      }

      // Tag options by category
      const categoryTags = {
        Spices: [
          "Cloves",
          "Cardamom",
          "Pepper",
          "Salt",
          "Cinnamon",
          "Garlic",
          "Ginger",
          "Bay leaf",
          "Mustard",
          "Coriander seeds",
        ],
        Grains: [
          "Rice",
          "Wheat",
          "Barley",
          "Oats",
          "Corn",
          "Millet",
          "Quinoa",
          "Rye",
          "Sorghum",
          "Buckwheat",
        ],
        Packaging: [
          "Boxes",
          "Bags",
          "Containers",
          "Bottles",
          "Jars",
          "Pouches",
          "Wraps",
          "Crates",
          "Pallets",
          "Labels",
        ],
        Machinery: [
          "Grinders",
          "Mixers",
          "Packaging machines",
          "Conveyors",
          "Scales",
          "Pumps",
          "Dryers",
          "Sealers",
          "Sorters",
          "Mills",
        ],
        Consulting: [
          "Business strategy",
          "Quality control",
          "Market research",
          "Export consulting",
          "Compliance",
          "Product development",
          "Training",
          "Auditing",
          "Certification",
          "Supply chain",
        ],
        Logistics: [
          "Shipping",
          "Warehousing",
          "Distribution",
          "Freight forwarding",
          "Customs clearance",
          "Cold storage",
          "Express delivery",
          "Cargo handling",
          "Import/Export",
          "Last mile",
        ],
        Maintenance: [
          "Equipment servicing",
          "Preventive maintenance",
          "Repairs",
          "Calibration",
          "Upgrades",
          "Troubleshooting",
          "Installation support",
          "Parts replacement",
          "Testing",
          "Inspection",
        ],
        Installation: [
          "Setup",
          "Configuration",
          "Testing",
          "Training",
          "Integration",
          "Commissioning",
          "Documentation",
          "Support",
          "Optimization",
          "Warranty",
        ],
      };

      // Tag selection state
      let productSelectedTags = [];
      let serviceSelectedTags = [];

      function setupTagSelection(
        categorySelectId,
        tagsGroupId,
        tagsDropdownId,
        selectedTagsContainerId,
        selectedTagsArray
      ) {
        const categorySelect = document.getElementById(categorySelectId);
        const tagsGroup = document.getElementById(tagsGroupId);
        const tagsDropdown = document.getElementById(tagsDropdownId);
        const selectedTagsContainer = document.getElementById(
          selectedTagsContainerId
        );

        categorySelect.addEventListener("change", function () {
          const category = this.value;
          selectedTagsArray.length = 0;
          selectedTagsContainer.innerHTML = "";
          tagsDropdown.innerHTML = '<option value="">Select a tag</option>';

          if (category && categoryTags[category]) {
            tagsGroup.style.display = "block";
            categoryTags[category].forEach((tag) => {
              const option = document.createElement("option");
              option.value = tag;
              option.textContent = tag;
              tagsDropdown.appendChild(option);
            });
          } else {
            tagsGroup.style.display = "none";
          }
        });

        tagsDropdown.addEventListener("change", function () {
          const tag = this.value;
          if (
            tag &&
            !selectedTagsArray.includes(tag) &&
            selectedTagsArray.length < 5
          ) {
            selectedTagsArray.push(tag);
            renderTagsFor(
              selectedTagsContainer,
              selectedTagsArray,
              tagsDropdownId
            );
            this.value = "";
          }
        });
      }

      function renderTagsFor(container, tagsArray, dropdownId) {
        container.innerHTML = "";
        tagsArray.forEach((tag, index) => {
          const tagElement = document.createElement("span");
          tagElement.style.cssText =
            "background: #f0f0f0; padding: 6px 12px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 14px;";
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.style.cssText =
            "background: none; border: none; cursor: pointer; font-size: 16px; color: #666; padding: 0; line-height: 1;";
          removeBtn.innerHTML = "&times;";
          removeBtn.onclick = function () {
            tagsArray.splice(index, 1);
            renderTagsFor(container, tagsArray, dropdownId);
          };
          tagElement.textContent = tag;
          tagElement.appendChild(removeBtn);
          container.appendChild(tagElement);
        });
      }

      function closeProductModal() {
        document.getElementById("productModal").classList.remove("active");
        document.getElementById("productForm").reset();
        document.getElementById("productTagsGroup").style.display = "none";
        productSelectedTags.length = 0; // Clear array without breaking reference
        document.getElementById("productSelectedTagsContainer").innerHTML = "";
      }

      function openServiceModal() {
        document.getElementById("serviceModal").classList.add("active");
      }

      function closeServiceModal() {
        document.getElementById("serviceModal").classList.remove("active");
        document.getElementById("serviceForm").reset();
        document.getElementById("serviceTagsGroup").style.display = "none";
        serviceSelectedTags.length = 0; // Clear array without breaking reference
        document.getElementById("serviceSelectedTagsContainer").innerHTML = "";
      }

      function editStoreDetails() {
        alert("Store editing feature coming soon!");
      }

      function deleteProduct(id) {
        if (confirm("Delete this product?")) {
          fetch(`/api/ads/${id}`, {
            method: "DELETE",
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("Product deleted successfully!");
                loadProductsFromDB();
              } else {
                alert(data.error || "Failed to delete product");
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Network error");
            });
        }
      }

      function deleteService(id) {
        if (confirm("Delete this service?")) {
          fetch(`/api/ads/${id}`, {
            method: "DELETE",
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("Service deleted successfully!");
                loadProductsFromDB();
              } else {
                alert(data.error || "Failed to delete service");
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Network error");
            });
        }
      }

      function editProduct(index) {
        alert("Product editing feature coming soon!");
      }

      function editService(index) {
        alert("Service editing feature coming soon!");
      }

      // Product form submission
      document
        .getElementById("productForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);

          console.log("Product tags:", productSelectedTags);
          if (productSelectedTags.length === 0) {
            alert("Please select at least one tag");
            return;
          }

          // Handle image upload first if present
          let imageUrl = null;
          const imageFile = fd.get("image");
          if (imageFile && imageFile.size > 0) {
            const imageData = new FormData();
            imageData.append("file", imageFile);
            try {
              const uploadRes = await fetch("/api/upload", {
                method: "POST",
                body: imageData,
              });
              const uploadData = await uploadRes.json();
              if (uploadData.success) {
                imageUrl = uploadData.url;
              }
            } catch (err) {
              console.error("Image upload failed:", err);
            }
          }

          const payload = {
            title: fd.get("name"),
            description: fd.get("description"),
            price: parseFloat(fd.get("price")),
            unit: "piece", // default unit
            category: fd.get("category"),
            tags: [...productSelectedTags],
            userId: user.id,
            imageUrl: imageUrl,
          };

          fetch("/api/ads", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("Product posted successfully!");
                document.getElementById("productForm").reset();
                productSelectedTags.length = 0; // Clear without breaking reference
                document.getElementById("productTagsGroup").style.display =
                  "none";
                document.getElementById(
                  "productSelectedTagsContainer"
                ).innerHTML = "";
                closeProductModal();
                // Reload products from database
                loadProductsFromDB();
              } else {
                alert(data.error || "Failed to post product");
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Network error");
            });
        });

      // Service form submission
      document
        .getElementById("serviceForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);

          console.log("Service tags:", serviceSelectedTags);
          if (serviceSelectedTags.length === 0) {
            alert("Please select at least one tag");
            return;
          }

          // Handle image upload first if present
          let imageUrl = null;
          const imageFile = fd.get("image");
          if (imageFile && imageFile.size > 0) {
            const imageData = new FormData();
            imageData.append("file", imageFile);
            try {
              const uploadRes = await fetch("/api/upload", {
                method: "POST",
                body: imageData,
              });
              const uploadData = await uploadRes.json();
              if (uploadData.success) {
                imageUrl = uploadData.url;
              }
            } catch (err) {
              console.error("Image upload failed:", err);
            }
          }

          const payload = {
            title: fd.get("name"),
            description: fd.get("description"),
            price: parseFloat(fd.get("price")),
            unit: "service", // default unit for services
            category: fd.get("category"),
            tags: [...serviceSelectedTags],
            userId: user.id,
            imageUrl: imageUrl,
          };

          fetch("/api/ads", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("Service posted successfully!");
                document.getElementById("serviceForm").reset();
                serviceSelectedTags.length = 0; // Clear without breaking reference
                document.getElementById("serviceTagsGroup").style.display =
                  "none";
                document.getElementById(
                  "serviceSelectedTagsContainer"
                ).innerHTML = "";
                closeServiceModal();
                // Reload services from database
                loadProductsFromDB();
              } else {
                alert(data.error || "Failed to post service");
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Network error");
            });
        });

      // Initial render - load from database
      loadProductsFromDB();

      // Setup tag selection for products and services
      setupTagSelection(
        "productCategory",
        "productTagsGroup",
        "productTagsDropdown",
        "productSelectedTagsContainer",
        productSelectedTags
      );
      setupTagSelection(
        "serviceCategory",
        "serviceTagsGroup",
        "serviceTagsDropdown",
        "serviceSelectedTagsContainer",
        serviceSelectedTags
      );
    </script>
  </body>
</html>
