<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SpiceTrade ‚Äî Buy & Sell Spices</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="header-left">
        <a href="/"
          ><img src="/logo.svg" alt="SpiceTrade logo" class="logo"
        /></a>
      </div>

      <div class="header-center">
        <form id="searchForm" class="search-form" role="search">
          <input
            id="q"
            name="q"
            type="search"
            placeholder="Search products, suppliers, ads... (eg. motors, lawn mowers)"
          />
          <button type="submit" class="search-btn" aria-label="Search">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#fff"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="7"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </button>
        </form>
      </div>

      <div class="header-right">
        <nav>
          <a href="/login.html" class="btn">Sign in</a>
          <a href="/signup.html" class="btn">Sign up</a>
        </nav>
      </div>
    </header>

    <div class="sub-header">
      <div class="category-scroll-wrapper">
        <button
          class="scroll-arrow scroll-left"
          id="scrollLeft"
          aria-label="Scroll left"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="header-tags" id="categoryTags">
          <a class="cat" href="#">Plumbing</a>
          <a class="cat" href="#">Office Automation</a>
          <a class="cat" href="#">Process Controllers</a>
          <a class="cat" href="#">Solar and Renewable Energy</a>
          <a class="cat" href="#">Commercial lights</a>
          <a class="cat" href="#">Medical Laboratory Instruments</a>
          <a class="cat" href="#">Agricultural Equipment</a>
        </div>
        <button
          class="scroll-arrow scroll-right"
          id="scrollRight"
          aria-label="Scroll right"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
    </div>

    <main class="market-hero">
      <div class="search-wrap">
        <h1>Find products, service providers & offers</h1>
        <p class="hint">Trusted listings from the spicetrade community</p>
      </div>

      <!-- Featured Products Section (Amazon-style) -->
      <section class="featured container">
        <div class="section-header">
          <h2>Featured Products</h2>
          <a href="/seller-dashboard.html" class="view-all"
            >View all products ‚Üí</a
          >
        </div>
        <div id="featuredProductsGrid" class="products-grid">
          Loading products...
        </div>
      </section>

      <section class="featured container">
        <div class="section-header">
          <h2>Featured Stores</h2>
          <a href="/all-stores.html" class="view-all">View all stores ‚Üí</a>
        </div>
        <div id="storesList" class="stores-grid">Loading stores...</div>
      </section>

      <section class="featured container">
        <div class="section-header">
          <h2>Latest Buyer Requirements</h2>
          <a href="/all-listings.html" class="view-all"
            >View all requirements ‚Üí</a
          >
        </div>
        <div id="adsList" class="ads-grid">Loading requirements...</div>
      </section>
    </main>

    <footer class="footer">
      &copy; Group of Spice Cloud Technologies, Canada, ESTB 2022
    </footer>

    <!-- Signup modal (shown when user clicks Sign up on landing) -->
    <div id="signupModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="signupModalTitle"
      >
        <button class="close" aria-label="Close">√ó</button>
        <h3 id="signupModalTitle">Join SpiceTrade</h3>
        <p class="muted">Choose how you'd like to use the platform</p>
        <div class="modal-options">
          <button class="opt buyer large" data-signup-role="buyer">
            Become a buyer
          </button>
          <button class="opt seller large" data-signup-role="seller">
            Become a seller
          </button>
        </div>
        <p class="muted small">You can switch later from your profile.</p>
      </div>
    </div>

    <script src="/app.js"></script>
    <script>
      // Category scroll functionality
      const categoryTags = document.getElementById("categoryTags");
      const scrollLeftBtn = document.getElementById("scrollLeft");
      const scrollRightBtn = document.getElementById("scrollRight");

      if (scrollRightBtn && categoryTags) {
        scrollRightBtn.addEventListener("click", () => {
          categoryTags.scrollBy({ left: 300, behavior: "smooth" });
        });
      }

      if (scrollLeftBtn && categoryTags) {
        scrollLeftBtn.addEventListener("click", () => {
          categoryTags.scrollBy({ left: -300, behavior: "smooth" });
        });
      }

      // Show/hide arrows based on scroll position
      function updateScrollArrows() {
        if (!categoryTags || !scrollLeftBtn || !scrollRightBtn) return;
        const scrollLeft = categoryTags.scrollLeft;
        const maxScroll = categoryTags.scrollWidth - categoryTags.clientWidth;

        scrollLeftBtn.style.display = scrollLeft > 0 ? "flex" : "none";
        scrollRightBtn.style.display =
          scrollLeft < maxScroll - 5 ? "flex" : "none";
      }

      if (categoryTags) {
        categoryTags.addEventListener("scroll", updateScrollArrows);
        window.addEventListener("resize", updateScrollArrows);
        // Initial check
        setTimeout(updateScrollArrows, 100);
      }

      // Load and render stores
      async function loadStores() {
        const list = document.getElementById("storesList");
        if (!list) return;
        try {
          const res = await fetch("/api/stores");
          const stores = await res.json();
          if (!stores || stores.length === 0) {
            list.innerHTML =
              '<p class="empty-message">No stores yet. Be the first to create one!</p>';
            return;
          }
          list.innerHTML = "";
          // Show only 8 stores (2 rows of 4), newest first
          stores
            .reverse()
            .slice(0, 8)
            .forEach((store) => {
              const card = document.createElement("div");
              card.className = "store-card";
              card.style.cursor = "pointer";
              card.addEventListener("click", () => {
                window.location.href = `/store.html?id=${store.id}`;
              });

              const logoHtml = store.logo
                ? `<img src="${escapeHtml(store.logo)}" alt="${escapeHtml(
                    store.storeName || store.name
                  )}" class="store-logo" />`
                : `<div class="store-logo-placeholder">${(
                    store.storeName ||
                    store.name ||
                    "S"
                  )
                    .charAt(0)
                    .toUpperCase()}</div>`;

              card.innerHTML = `
              ${logoHtml}
              <div class="store-info">
                <h3>${escapeHtml(store.storeName || store.name || "Store")}</h3>
                <p class="store-category">${escapeHtml(
                  store.categories || store.businessType || "General"
                )}</p>
                ${
                  store.address
                    ? `<p class="store-location"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> ${escapeHtml(
                        store.address.substring(0, 40)
                      )}${store.address.length > 40 ? "..." : ""}</p>`
                    : ""
                }
                <div class="store-meta">
                  <span class="badge">${escapeHtml(
                    store.businessType || "Seller"
                  )}</span>
                </div>
              </div>
            `;
              list.appendChild(card);
            });
        } catch (err) {
          console.error("Error loading stores:", err);
          list.innerHTML =
            '<p class="error-message">Error loading stores. Please try again later.</p>';
        }
      }

      // Load Featured Products (from sellers only)
      async function loadFeaturedProducts() {
        const grid = document.getElementById("featuredProductsGrid");
        if (!grid) return;

        try {
          const res = await fetch("/api/ads");
          const ads = await res.json();

          console.log("Total ads fetched:", ads.length);
          console.log("Sample ad:", ads[0]);

          // Filter for seller products only (role === 'seller' AND has price)
          const products = ads.filter((ad) => {
            const isSeller = ad.role === "seller";
            const hasPrice = ad.price && ad.price > 0;
            console.log(
              `Ad ${ad.id}: role=${ad.role}, price=${ad.price}, passes=${
                isSeller && hasPrice
              }`
            );
            return isSeller && hasPrice;
          });

          console.log("Filtered products:", products.length);

          if (!products || products.length === 0) {
            grid.innerHTML = `
              <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: #f9f9f9; border-radius: 8px; border: 2px dashed #ddd;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                <h3 style="margin: 0 0 12px 0; color: #333;">No Products Available Yet</h3>
                <p style="color: #666; margin: 0 0 20px 0;">Be the first seller to list products with pricing!</p>
                <a href="/signup.html?role=seller" class="btn" style="display: inline-block; padding: 12px 24px; background: var(--accent); color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">Start Selling</a>
              </div>
            `;
            return;
          }

          grid.innerHTML = "";
          // Show first 12 products
          products.slice(0, 12).forEach((product) => {
            const card = document.createElement("div");
            card.className = "product-card";
            card.onclick = () =>
              (window.location.href = `/listing.html?id=${product.id}`);

            // Product Image
            const imgUrl = product.imageUrl || "/placeholder-product.jpg";
            const img = document.createElement("img");
            img.className = "product-image";
            img.src = imgUrl;
            img.alt = product.title;
            img.loading = "lazy";
            img.onerror = function () {
              this.style.background = "#f5f5f5";
              this.style.display = "flex";
              this.style.alignItems = "center";
              this.style.justifyContent = "center";
              this.alt = "üì¶";
              this.src =
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><text x="50%" y="50%" font-size="48" text-anchor="middle" dy=".3em">üì¶</text></svg>';
            };
            card.appendChild(img);

            // Product Info
            const info = document.createElement("div");
            info.className = "product-info";

            // Product Title
            const title = document.createElement("h3");
            title.className = "product-title";
            title.textContent = product.title;
            info.appendChild(title);

            // Rating & Reviews (placeholder for now)
            const rating = document.createElement("div");
            rating.className = "product-rating";
            rating.innerHTML = `
              <span class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
              <span class="review-count">(${
                Math.floor(Math.random() * 500) + 50
              })</span>
            `;
            info.appendChild(rating);

            // Price
            const priceDiv = document.createElement("div");
            priceDiv.className = "product-price";
            const priceAmount = document.createElement("span");
            priceAmount.className = "price-amount";
            priceAmount.textContent = `$${parseFloat(product.price).toFixed(
              2
            )}`;
            priceDiv.appendChild(priceAmount);

            if (product.unit) {
              const unit = document.createElement("span");
              unit.className = "price-unit";
              unit.textContent = `/${product.unit}`;
              priceDiv.appendChild(unit);
            }
            info.appendChild(priceDiv);

            // MOQ
            if (product.minOrder) {
              const moq = document.createElement("div");
              moq.className = "product-moq";
              moq.textContent = `Min. Order: ${product.minOrder} ${
                product.unit || "units"
              }`;
              info.appendChild(moq);
            }

            // Supplier Badge
            if (product.storeName) {
              const supplier = document.createElement("div");
              supplier.className = "product-supplier";
              supplier.innerHTML = `
                <span class="supplier-name">üè™ ${escapeHtml(
                  product.storeName
                )}</span>
                ${
                  product.verified ? '<span class="verified-mini">‚úì</span>' : ""
                }
              `;
              info.appendChild(supplier);
            }

            // Prime/Fast Delivery Badge (if in stock)
            if (product.stock && product.stock > 0) {
              const badge = document.createElement("div");
              badge.className = "delivery-badge";
              badge.textContent = "In Stock";
              info.appendChild(badge);
            }

            card.appendChild(info);
            grid.appendChild(card);
          });
        } catch (err) {
          console.error("Error loading products:", err);
          grid.innerHTML =
            '<p class="error-message">Error loading products.</p>';
        }
      }

      // Initialize
      loadFeaturedProducts();
      loadStores();
    </script>
  </body>
</html>
