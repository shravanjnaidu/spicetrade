<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard â€” spicetrade</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <a href="/"><img src="/logo.svg" alt="spicetrade logo" class="logo" /></a>
      <nav>
        <a href="/signup.html" class="btn">Sign up / Login</a>
        <a href="/" class="btn secondary">Home</a>
      </nav>
    </header>

    <main class="container">
      <section class="card">
        <h2>Post a new ad</h2>
        <form id="adForm">
          <label
            >Title
            <input name="title" required />
          </label>
          <label
            >Description
            <textarea name="description" required></textarea>
          </label>
          <label
            >Category *
            <select id="adCategory" name="category" required>
              <option value="">Select category</option>
              <option value="Spices">Spices</option>
              <option value="Grains">Grains</option>
              <option value="Packaging">Packaging</option>
              <option value="Machinery">Machinery</option>
              <option value="Other">Other</option>
            </select>
          </label>
          <div id="adTagsGroup" style="display: none; margin-bottom: 16px">
            <label style="display: block; margin-bottom: 8px; font-weight: 500"
              >Select Tag *</label
            >
            <select
              id="adTagsDropdown"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #e6e6e6;
                border-radius: 6px;
              "
            >
              <option value="">Select a tag</option>
            </select>
            <div
              id="selectedTagsContainer"
              style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px"
            ></div>
          </div>
          <button class="btn" type="submit">Publish Ad</button>
        </form>
      </section>

      <section class="card">
        <h2>Latest ads</h2>
        <div id="adsList">Loading...</div>
      </section>
    </main>

    <script src="/app.js"></script>
    <script>
      // Tag options by category for buyer listings
      const categoryTags = {
        Spices: [
          "Cloves",
          "Cardamom",
          "Pepper",
          "Salt",
          "Cinnamon",
          "Garlic",
          "Ginger",
          "Bay leaf",
          "Mustard",
          "Coriander seeds",
        ],
        Grains: [
          "Rice",
          "Wheat",
          "Barley",
          "Oats",
          "Corn",
          "Millet",
          "Quinoa",
          "Rye",
          "Sorghum",
          "Buckwheat",
        ],
        Packaging: [
          "Boxes",
          "Bags",
          "Containers",
          "Bottles",
          "Jars",
          "Pouches",
          "Wraps",
          "Crates",
          "Pallets",
          "Labels",
        ],
        Machinery: [
          "Grinders",
          "Mixers",
          "Packaging machines",
          "Conveyors",
          "Scales",
          "Pumps",
          "Dryers",
          "Sealers",
          "Sorters",
          "Mills",
        ],
      };

      // Setup tag selection for ad category
      const adCategorySelect = document.getElementById("adCategory");
      const adTagsGroup = document.getElementById("adTagsGroup");
      const adTagsDropdown = document.getElementById("adTagsDropdown");
      const selectedTagsContainer = document.getElementById(
        "selectedTagsContainer"
      );
      let selectedTags = [];

      adCategorySelect.addEventListener("change", function () {
        const category = this.value;
        selectedTags = [];
        selectedTagsContainer.innerHTML = "";
        adTagsDropdown.innerHTML = '<option value="">Select a tag</option>';

        if (category && categoryTags[category]) {
          adTagsGroup.style.display = "block";
          categoryTags[category].forEach((tag) => {
            const option = document.createElement("option");
            option.value = tag;
            option.textContent = tag;
            adTagsDropdown.appendChild(option);
          });
        } else {
          adTagsGroup.style.display = "none";
        }
      });

      adTagsDropdown.addEventListener("change", function () {
        const tag = this.value;
        if (tag && !selectedTags.includes(tag) && selectedTags.length < 5) {
          selectedTags.push(tag);
          renderSelectedTags();
          this.value = "";
        }
      });

      function renderSelectedTags() {
        selectedTagsContainer.innerHTML = "";
        selectedTags.forEach((tag, index) => {
          const tagElement = document.createElement("span");
          tagElement.style.cssText =
            "background: #f0f0f0; padding: 6px 12px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 14px;";
          tagElement.innerHTML = `
            ${tag}
            <button type="button" style="background: none; border: none; cursor: pointer; font-size: 16px; color: #666; padding: 0; line-height: 1;" onclick="removeAdTag(${index})">&times;</button>
          `;
          selectedTagsContainer.appendChild(tagElement);
        });
      }

      window.removeAdTag = function (index) {
        selectedTags.splice(index, 1);
        renderSelectedTags();
      };

      // Override the original ad form submission to include tags
      const originalAdForm = document.getElementById("adForm");
      const originalSubmitHandler = originalAdForm.onsubmit;

      document
        .getElementById("adForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          if (
            selectedTags.length === 0 &&
            adTagsGroup.style.display !== "none"
          ) {
            alert("Please select at least one tag");
            return;
          }

          const fd = new FormData(this);
          const payload = {
            title: fd.get("title"),
            description: fd.get("description"),
            category: fd.get("category"),
            tags: selectedTags,
          };

          fetch("/api/ads", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("Ad posted successfully!");
                this.reset();
                selectedTags = [];
                adTagsGroup.style.display = "none";
                selectedTagsContainer.innerHTML = "";
                loadAds();
              } else {
                alert(data.error || "Failed to post ad");
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Network error");
            });
        });
    </script>
  </body>
</html>
