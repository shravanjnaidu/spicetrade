<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Listing Details ‚Äî spicetrade</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .listing-container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 16px;
        flex: 1 0 auto;
      }
      .listing-detail {
        background: #fff;
        border: 1px solid #e9e9e9;
        border-radius: 12px;
        overflow: hidden;
      }
      .listing-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        background: #f5f5f5;
      }
      .listing-content {
        padding: 32px;
      }
      .listing-header {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 2px solid #f5f5f5;
      }
      .listing-header h1 {
        margin: 0 0 12px 0;
        font-size: 32px;
        color: #222;
      }
      .listing-meta {
        display: flex;
        gap: 20px;
        color: #666;
        font-size: 14px;
      }
      .listing-description {
        margin-bottom: 32px;
      }
      .listing-description h2 {
        font-size: 20px;
        margin: 0 0 16px 0;
        color: #222;
      }
      .listing-description p {
        line-height: 1.8;
        color: #444;
        font-size: 16px;
      }
      .listing-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        background: #fafafa;
        border-top: 1px solid #e9e9e9;
      }
      .author-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .author-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), #f39c12);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }
      .author-details span {
        display: block;
        font-size: 13px;
        color: #666;
      }
      .author-details strong {
        font-size: 16px;
        color: #222;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <a href="/"><img src="/logo.svg" alt="spicetrade logo" class="logo" /></a>
      <div class="header-right"></div>
    </header>

    <main class="listing-container">
      <div class="listing-detail">
        <div id="listingImageContainer"></div>
        <div class="listing-content">
          <div class="listing-header">
            <h1 id="listingTitle">Loading...</h1>
            <div class="listing-meta">
              <span id="listingDate">‚Äî</span>
              <span>‚Ä¢</span>
              <span id="listingAuthor">Posted by ‚Äî</span>
            </div>
          </div>

          <div class="listing-description">
            <h2>Description</h2>
            <p id="listingDescription">‚Äî</p>
          </div>

          <div
            id="listingTagsSection"
            style="margin-bottom: 24px; display: none"
          >
            <h2 style="font-size: 20px; margin: 0 0 12px 0; color: #222">
              Tags
            </h2>
            <div
              id="listingTags"
              style="display: flex; flex-wrap: wrap; gap: 8px"
            ></div>
          </div>
        </div>

        <div class="listing-footer">
          <div class="author-info">
            <div class="author-avatar" id="authorAvatar">A</div>
            <div class="author-details">
              <span>Posted by</span>
              <strong id="authorName">‚Äî</strong>
            </div>
          </div>
          <div id="listingActions" style="display: flex; gap: 12px;">
            <button class="btn" onclick="contactSeller()" id="contactBtn">
              Contact Seller
            </button>
            <button class="btn secondary" onclick="toggleWishlist()" id="wishlistBtn" style="display: none;">
              Add to Wishlist
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      &copy; Group of Spice Cloud Technologies, Canada, ESTB 2022
    </footer>

    <script src="/app.js"></script>
    <script>
      const params = new URLSearchParams(location.search);
      const listingId = params.get("id");

      if (!listingId) {
        alert("Listing not found.");
        location.href = "/";
      } else {
        loadListing();
      }

      async function loadListing() {
        try {
          const res = await fetch("/api/ads");
          const data = await res.json();
          const listings = data.success ? data.ads : data;
          const listing = listings.find((l) => l.id == listingId);

          if (!listing) {
            alert("Listing not found.");
            location.href = "/";
            return;
          }

          // Get current user
          const user = JSON.parse(
            localStorage.getItem("spicetrade_user") || "null"
          );
          const isOwner = user && user.id === listing.userId;

          // Populate listing details
          document.getElementById("listingTitle").textContent =
            listing.title || "Untitled";
          document.getElementById("listingDescription").textContent =
            listing.description || "No description provided.";
          document.getElementById("listingDate").textContent = listing.createdAt
            ? new Date(listing.createdAt).toLocaleDateString()
            : "‚Äî";
          document.getElementById("listingAuthor").textContent = `Posted by ${
            listing.author || "Anonymous"
          }`;

          const initial = (listing.author || "A").charAt(0).toUpperCase();
          document.getElementById("authorAvatar").textContent = initial;
          document.getElementById("authorName").textContent =
            listing.author || "Anonymous";

          // Update contact button text based on poster role
          const contactBtn = document.getElementById("contactBtn");
          if (listing.role === "buyer") {
            contactBtn.textContent = "Contact Buyer";
          } else {
            contactBtn.textContent = "Contact Seller";
          }

          // Show edit/delete buttons if user owns this listing
          const actionsDiv = document.getElementById("listingActions");
          if (isOwner) {
            contactBtn.style.display = "none";
            actionsDiv.innerHTML = `
              <button class="btn secondary" onclick="editListing()">Edit</button>
              <button class="btn secondary" onclick="deleteListing()" style="background: #dc3545; border-color: #dc3545;">Delete</button>
            `;
          } else if (user && user.id) {
            // Only show contact button if user is logged in and not the owner
            contactBtn.style.display = "inline-block";

            // For buyers viewing seller listings, allow contact
            // For sellers viewing buyer requirements, allow contact only if conversation exists
            if (user.role === "buyer" && listing.role === "seller") {
              contactBtn.onclick = () => contactSeller(listing);
              
              // Show wishlist button for buyers viewing seller products
              const wishlistBtn = document.getElementById("wishlistBtn");
              wishlistBtn.style.display = "inline-block";
              
              // Check if already in wishlist
              checkWishlistStatus(user.id, listing.id);
            } else if (user.role === "seller" && listing.role === "buyer") {
              contactBtn.onclick = () => contactBuyer(listing);
            }
          } else {
            // Not logged in - prompt to sign in
            contactBtn.onclick = () => {
              alert("Please sign in to contact the seller");
              window.location.href = "/login.html";
            };
          }

          // Show tags if available
          if (listing.tags && listing.tags.length > 0) {
            document.getElementById("listingTagsSection").style.display =
              "block";
            const tagsContainer = document.getElementById("listingTags");
            listing.tags.forEach((tag) => {
              const tagEl = document.createElement("span");
              tagEl.style.cssText =
                "background: #f0f0f0; padding: 6px 12px; border-radius: 4px; font-size: 13px; color: #555; text-transform: lowercase;";
              tagEl.textContent = tag;
              tagsContainer.appendChild(tagEl);
            });
          }

          // Show image if available
          if (listing.imageUrl) {
            const imgHtml = `<img src="${listing.imageUrl}" alt="${listing.title}" class="listing-image" />`;
            document.getElementById("listingImageContainer").innerHTML =
              imgHtml;
          }
        } catch (err) {
          console.error("Error loading listing:", err);
          alert("Error loading listing details.");
        }
      }

      async function contactSeller(listing) {
        // Buyer contacting seller
        const user = JSON.parse(
          localStorage.getItem("spicetrade_user") || "null"
        );

        if (!user || !user.id) {
          alert("Please sign in to contact the seller");
          window.location.href = "/login.html";
          return;
        }

        try {
          // Start or get existing conversation
          const res = await fetch("/api/conversations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              buyerId: user.id,
              sellerId: listing.userId,
              listingId: listing.id,
            }),
          });

          const result = await res.json();

          if (result.success) {
            // Redirect to messages page
            window.location.href = `/messages.html?conversation=${result.conversationId}`;
          } else {
            alert("Failed to start conversation");
          }
        } catch (err) {
          console.error("Error starting conversation:", err);
          alert("Failed to start conversation");
        }
      }

      async function contactBuyer(listing) {
        // Seller contacting buyer (only if conversation already exists)
        const user = JSON.parse(
          localStorage.getItem("spicetrade_user") || "null"
        );

        if (!user || !user.id) {
          alert("Please sign in to contact the buyer");
          window.location.href = "/login.html";
          return;
        }

        try {
          // Check if conversation exists (buyer must have initiated)
          const res = await fetch(`/api/conversations/${user.id}`);
          const conversations = await res.json();

          const existingConv = conversations.find(
            (c) => c.buyerId === listing.userId && c.sellerId === user.id
          );

          if (existingConv) {
            // Conversation exists, go to messages
            window.location.href = `/messages.html?conversation=${existingConv.id}`;
          } else {
            // No existing conversation - seller cannot initiate
            alert(
              "You can only respond to messages from buyers. Wait for the buyer to contact you first."
            );
          }
        } catch (err) {
          console.error("Error checking conversation:", err);
          alert("Failed to check conversation");
        }
      }

      function editListing() {
        alert("Edit feature coming soon! You can delete and recreate for now.");
      }

      async function deleteListing() {
        if (!confirm("Are you sure you want to delete this listing?")) {
          return;
        }

        try {
          const res = await fetch(`/api/ads/${listingId}`, {
            method: "DELETE",
          });
          const data = await res.json();

          if (data.success) {
            alert("Listing deleted successfully!");
            location.href = "/";
          } else {
            alert(data.error || "Failed to delete listing");
          }
        } catch (err) {
          console.error("Error deleting listing:", err);
          alert("Error deleting listing");
        }
      }

      let currentWishlistId = null;

      async function checkWishlistStatus(userId, adId) {
        try {
          const res = await fetch('/api/wishlist/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, adId })
          });
          const data = await res.json();
          
          const wishlistBtn = document.getElementById('wishlistBtn');
          if (data.inWishlist) {
            wishlistBtn.textContent = '‚ù§Ô∏è Wishlisted';
            wishlistBtn.style.background = '#ff4757';
            wishlistBtn.style.borderColor = '#ff4757';
            wishlistBtn.style.color = 'white';
            currentWishlistId = data.wishlistId;
          } else {
            wishlistBtn.textContent = 'ü§ç Add to Wishlist';
            wishlistBtn.style.background = '';
            wishlistBtn.style.borderColor = '';
            wishlistBtn.style.color = '';
            currentWishlistId = null;
          }
        } catch (err) {
          console.error('Error checking wishlist:', err);
        }
      }

      async function toggleWishlist() {
        const user = JSON.parse(localStorage.getItem('spicetrade_user') || 'null');
        if (!user || !user.id) {
          alert('Please sign in to use wishlist');
          window.location.href = '/login.html';
          return;
        }

        const wishlistBtn = document.getElementById('wishlistBtn');
        wishlistBtn.disabled = true;

        try {
          if (currentWishlistId) {
            // Remove from wishlist
            const res = await fetch(`/api/wishlist/${currentWishlistId}`, {
              method: 'DELETE'
            });
            const data = await res.json();
            
            if (data.success) {
              wishlistBtn.textContent = 'ü§ç Add to Wishlist';
              wishlistBtn.style.background = '';
              wishlistBtn.style.borderColor = '';
              wishlistBtn.style.color = '';
              currentWishlistId = null;
            } else {
              alert('Failed to remove from wishlist');
            }
          } else {
            // Add to wishlist
            const res = await fetch('/api/wishlist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId: user.id, adId: parseInt(listingId) })
            });
            const data = await res.json();
            
            if (data.success) {
              wishlistBtn.textContent = '‚ù§Ô∏è Wishlisted';
              wishlistBtn.style.background = '#ff4757';
              wishlistBtn.style.borderColor = '#ff4757';
              wishlistBtn.style.color = 'white';
              currentWishlistId = data.wishlistId;
            } else {
              alert(data.message || 'Failed to add to wishlist');
            }
          }
        } catch (err) {
          console.error('Error toggling wishlist:', err);
          alert('Failed to update wishlist');
        } finally {
          wishlistBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
