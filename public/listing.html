<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Listing Details â€” spicetrade</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .listing-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 24px;
        flex: 1 0 auto;
      }
      .listing-detail {
        display: grid;
        grid-template-columns: 1fr 1.2fr 400px;
        gap: 24px;
        background: #fff;
        padding: 24px;
        margin-bottom: 20px;
      }

      /* Left Column - Image Gallery */
      .listing-image-section {
        height: fit-content;
        display: flex;
        gap: 12px;
      }
      .image-thumbnails {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: border-color 0.2s;
      }
      .thumbnail:hover {
        border-color: #ffa41c;
      }
      .thumbnail.active {
        border-color: #ffa41c;
        box-shadow: 0 0 4px rgba(255, 164, 28, 0.5);
      }
      .main-image-container {
        flex: 1;
      }
      .listing-image {
        width: 100%;
        height: auto;
        max-height: 500px;
        object-fit: contain;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      /* Middle Column - Details */
      .listing-content {
        padding: 0 16px;
      }
      .listing-header h1 {
        margin: 0 0 8px 0;
        font-size: 24px;
        color: #0f1111;
        font-weight: 400;
        line-height: 1.3;
      }
      .listing-rating {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e7e7e7;
      }
      .stars {
        color: #ffa41c;
        font-size: 14px;
      }
      .rating-count {
        color: #007185;
        font-size: 14px;
        cursor: pointer;
      }
      .rating-count:hover {
        color: #c45500;
        text-decoration: underline;
      }
      .product-price-section {
        background: #f7f7f7;
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
      }
      .price-label {
        color: #565959;
        font-size: 14px;
        margin-bottom: 4px;
      }
      .product-price {
        font-size: 28px;
        color: #0f1111;
        font-weight: 400;
      }
      .price-unit {
        font-size: 18px;
        color: #565959;
      }
      .product-moq {
        color: #565959;
        font-size: 14px;
        margin-top: 8px;
      }
      .product-details-section {
        margin: 20px 0;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #0f1111;
        margin: 0 0 12px 0;
      }
      .detail-item {
        display: flex;
        padding: 8px 0;
        border-bottom: 1px solid #e7e7e7;
      }
      .detail-label {
        flex: 0 0 150px;
        color: #565959;
        font-size: 14px;
      }
      .detail-value {
        color: #0f1111;
        font-size: 14px;
      }
      .listing-description {
        margin: 20px 0;
      }
      .listing-description h2 {
        font-size: 16px;
        font-weight: 700;
        margin: 0 0 12px 0;
        color: #0f1111;
      }
      .listing-description p {
        line-height: 1.6;
        color: #0f1111;
        font-size: 14px;
      }
      .product-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 16px 0;
      }
      .tag-item {
        background: #f0f2f2;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        color: #0f1111;
        border: 1px solid #d5d9d9;
      }

      /* Reviews Section */
      .reviews-section {
        grid-column: 1 / -1;
        margin-top: 40px;
        padding-top: 40px;
        border-top: 1px solid #e7e7e7;
      }
      .review-summary {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 40px;
        margin-bottom: 40px;
      }
      .rating-overview {
        text-align: center;
      }
      .avg-rating {
        font-size: 48px;
        font-weight: 400;
        color: #0f1111;
        margin-bottom: 8px;
      }
      .avg-stars {
        color: #ffa41c;
        font-size: 20px;
        margin-bottom: 8px;
      }
      .total-ratings {
        color: #565959;
        font-size: 14px;
      }
      .rating-breakdown {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .rating-bar-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .rating-label {
        color: #007185;
        font-size: 14px;
        cursor: pointer;
        width: 60px;
      }
      .rating-label:hover {
        color: #c45500;
        text-decoration: underline;
      }
      .rating-bar {
        flex: 1;
        height: 20px;
        background: #e7e7e7;
        border-radius: 4px;
        overflow: hidden;
      }
      .rating-bar-fill {
        height: 100%;
        background: #ffa41c;
        transition: width 0.3s;
      }
      .rating-count {
        color: #565959;
        font-size: 14px;
        width: 50px;
        text-align: right;
      }
      .review-form-section {
        background: #f7f7f7;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }
      .review-form-section h3 {
        font-size: 16px;
        font-weight: 700;
        color: #0f1111;
        margin: 0 0 16px 0;
      }
      .star-rating-input {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .star-input {
        font-size: 32px;
        cursor: pointer;
        color: #e7e7e7;
        transition: color 0.2s;
      }
      .star-input.active,
      .star-input:hover {
        color: #ffa41c;
      }
      .review-textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid #d5d9d9;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
      }
      .review-item {
        padding: 20px 0;
        border-bottom: 1px solid #e7e7e7;
      }
      .review-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .reviewer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), #f39c12);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 16px;
      }
      .reviewer-info {
        flex: 1;
      }
      .reviewer-name {
        font-weight: 700;
        color: #0f1111;
        font-size: 14px;
      }
      .review-date {
        color: #565959;
        font-size: 12px;
      }
      .review-stars {
        color: #ffa41c;
        font-size: 14px;
        margin-bottom: 8px;
      }
      .review-text {
        color: #0f1111;
        font-size: 14px;
        line-height: 1.6;
      }
      .review-actions {
        margin-top: 12px;
        display: flex;
        gap: 12px;
      }
      .review-action-btn {
        background: none;
        border: none;
        color: #007185;
        font-size: 13px;
        cursor: pointer;
        padding: 4px 8px;
      }
      .review-action-btn:hover {
        color: #c45500;
        text-decoration: underline;
      }

      /* Right Column - Buy Box */
      .buy-box {
        height: fit-content;
        border: 1px solid #d5d9d9;
        border-radius: 8px;
        padding: 20px;
        background: #fff;
      }
      .buy-box-price {
        font-size: 28px;
        color: #0f1111;
        margin-bottom: 8px;
      }
      .buy-box-delivery {
        color: #007600;
        font-size: 14px;
        margin: 8px 0;
        font-weight: 700;
      }
      .buy-box-stock {
        color: #007600;
        font-size: 18px;
        font-weight: 400;
        margin: 12px 0;
      }
      .buy-box-seller {
        margin: 16px 0;
        padding: 12px 0;
        border-top: 1px solid #e7e7e7;
        border-bottom: 1px solid #e7e7e7;
      }
      .seller-label {
        color: #565959;
        font-size: 12px;
      }
      .seller-name {
        color: #007185;
        font-size: 14px;
        margin-top: 4px;
        cursor: pointer;
      }
      .seller-name:hover {
        color: #c45500;
        text-decoration: underline;
      }
      .buy-box-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 16px;
      }
      .buy-box-btn {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        font-weight: 500;
        transition: all 0.2s;
      }
      .buy-box-btn.primary {
        background: #ffd814;
        color: #0f1111;
        border: 1px solid #fcd200;
      }
      .buy-box-btn.primary:hover {
        background: #f7ca00;
      }
      .buy-box-btn.secondary {
        background: #ffa41c;
        color: #0f1111;
        border: 1px solid #ff8f00;
      }
      .buy-box-btn.secondary:hover {
        background: #fa8900;
      }
      .buy-box-btn.wishlist {
        background: #fff;
        color: #0f1111;
        border: 1px solid #d5d9d9;
      }
      .buy-box-btn.wishlist:hover {
        background: #f7fafa;
      }
      .buy-box-security {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e7e7e7;
        font-size: 12px;
        color: #565959;
      }

      @media (max-width: 1024px) {
        .listing-detail {
          grid-template-columns: 1fr;
        }
        .listing-image-section {
          flex-direction: column-reverse;
        }
        .image-thumbnails {
          flex-direction: row;
          overflow-x: auto;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <a href="/"><img src="/logo.svg" alt="spicetrade logo" class="logo" /></a>
      <div class="header-right"></div>
    </header>

    <main class="listing-container">
      <div class="listing-detail">
        <!-- Left Column - Image Gallery -->
        <div class="listing-image-section">
          <div class="image-thumbnails" id="imageThumbnails"></div>
          <div class="main-image-container">
            <img
              src="/placeholder-product.jpg"
              alt="Product"
              class="listing-image"
              id="productImage"
            />
          </div>
        </div>

        <!-- Middle Column - Product Details -->
        <div class="listing-content">
          <div class="listing-header">
            <h1 id="listingTitle">Loading...</h1>
            <div class="listing-rating">
              <span class="stars">â˜…â˜…â˜…â˜…â˜…</span>
              <span class="rating-count" id="ratingCount">128 ratings</span>
            </div>
          </div>

          <div
            class="product-price-section"
            id="priceSectionMobile"
            style="display: none"
          >
            <div class="price-label">Price:</div>
            <div class="product-price">
              <span id="productPriceMobile">â€”</span>
              <span class="price-unit" id="priceUnitMobile"></span>
            </div>
            <div class="product-moq" id="moqMobile"></div>
          </div>

          <div class="product-details-section">
            <h2 class="section-title">Product Details</h2>
            <div class="detail-item">
              <span class="detail-label">Category</span>
              <span class="detail-value" id="productCategory">â€”</span>
            </div>
            <div class="detail-item" id="unitRow" style="display: none">
              <span class="detail-label">Unit</span>
              <span class="detail-value" id="productUnit">â€”</span>
            </div>
            <div class="detail-item" id="moqRow" style="display: none">
              <span class="detail-label">Minimum Order</span>
              <span class="detail-value" id="productMOQ">â€”</span>
            </div>
            <div class="detail-item" id="stockRow" style="display: none">
              <span class="detail-label">Stock</span>
              <span class="detail-value" id="productStock">â€”</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Posted</span>
              <span class="detail-value" id="listingDate">â€”</span>
            </div>
          </div>

          <div class="listing-description">
            <h2>About this product</h2>
            <p id="listingDescription">â€”</p>
          </div>

          <div id="listingTagsSection" style="display: none">
            <h2 class="section-title">Tags</h2>
            <div class="product-tags" id="listingTags"></div>
          </div>
        </div>

        <!-- Right Column - Buy Box -->
        <div class="buy-box">
          <div class="buy-box-price">
            <span id="productPrice">â€”</span>
            <span class="price-unit" id="priceUnit"></span>
          </div>
          <div class="product-moq" id="moqBox"></div>

          <div class="buy-box-stock" id="stockStatus">In Stock</div>

          <div class="buy-box-seller">
            <div class="seller-label">Sold by</div>
            <a class="seller-name" id="sellerName" href="#">â€”</a>
          </div>

          <div class="buy-box-actions" id="buyBoxActions">
            <button class="buy-box-btn primary" id="contactBtn">
              Contact Seller
            </button>
            <button
              class="buy-box-btn wishlist"
              id="wishlistBtn"
              style="display: none"
            >
              â™¡ Add to Wishlist
            </button>
          </div>

          <div class="buy-box-security">
            <div>ðŸ”’ Secure transaction</div>
            <div style="margin-top: 8px">ðŸ“¦ Ships from verified seller</div>
          </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section" id="reviewsSection">
          <h2 class="section-title">Customer Reviews</h2>

          <div class="review-summary" id="reviewSummary">
            <div class="rating-overview">
              <div class="avg-rating" id="avgRating">0</div>
              <div class="avg-stars" id="avgStars">â˜†â˜†â˜†â˜†â˜†</div>
              <div class="total-ratings" id="totalRatings">0 ratings</div>
            </div>

            <div class="rating-breakdown">
              <div class="rating-bar-row">
                <span class="rating-label">5 star</span>
                <div class="rating-bar">
                  <div
                    class="rating-bar-fill"
                    id="bar5"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="rating-count" id="count5">0</span>
              </div>
              <div class="rating-bar-row">
                <span class="rating-label">4 star</span>
                <div class="rating-bar">
                  <div
                    class="rating-bar-fill"
                    id="bar4"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="rating-count" id="count4">0</span>
              </div>
              <div class="rating-bar-row">
                <span class="rating-label">3 star</span>
                <div class="rating-bar">
                  <div
                    class="rating-bar-fill"
                    id="bar3"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="rating-count" id="count3">0</span>
              </div>
              <div class="rating-bar-row">
                <span class="rating-label">2 star</span>
                <div class="rating-bar">
                  <div
                    class="rating-bar-fill"
                    id="bar2"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="rating-count" id="count2">0</span>
              </div>
              <div class="rating-bar-row">
                <span class="rating-label">1 star</span>
                <div class="rating-bar">
                  <div
                    class="rating-bar-fill"
                    id="bar1"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="rating-count" id="count1">0</span>
              </div>
            </div>
          </div>

          <!-- Review Form -->
          <div
            class="review-form-section"
            id="reviewFormSection"
            style="display: none"
          >
            <h3>Write a review</h3>
            <div class="star-rating-input" id="starRatingInput">
              <span class="star-input" data-rating="1">â˜…</span>
              <span class="star-input" data-rating="2">â˜…</span>
              <span class="star-input" data-rating="3">â˜…</span>
              <span class="star-input" data-rating="4">â˜…</span>
              <span class="star-input" data-rating="5">â˜…</span>
            </div>
            <textarea
              class="review-textarea"
              id="reviewText"
              placeholder="Share your experience with this product..."
            ></textarea>
            <div style="margin-top: 12px">
              <button
                class="buy-box-btn primary"
                onclick="submitReview()"
                style="width: auto; padding: 10px 24px"
              >
                Submit Review
              </button>
            </div>
          </div>

          <!-- Reviews List -->
          <div id="reviewsList"></div>
        </div>
      </div>
    </main>

    <footer class="footer">
      &copy; Group of Spice Cloud Technologies, Canada, ESTB 2022
    </footer>

    <script src="/app.js"></script>
    <script>
      const params = new URLSearchParams(location.search);
      const listingId = params.get("id");

      if (!listingId) {
        alert("Listing not found.");
        location.href = "/";
      } else {
        loadListing();
      }

      async function loadListing() {
        try {
          const res = await fetch("/api/ads");
          const data = await res.json();
          const listings = data.success ? data.ads : data;
          const listing = listings.find((l) => l.id == listingId);

          if (!listing) {
            alert("Listing not found.");
            location.href = "/";
            return;
          }

          // Get current user
          const user = JSON.parse(
            localStorage.getItem("spicetrade_user") || "null"
          );
          const isOwner = user && user.id === listing.userId;

          // Populate listing details
          document.getElementById("listingTitle").textContent =
            listing.title || "Untitled";
          document.getElementById("listingDescription").textContent =
            listing.description || "No description provided.";
          document.getElementById("listingDate").textContent = listing.createdAt
            ? new Date(listing.createdAt).toLocaleDateString()
            : "â€”";

          // Populate category
          document.getElementById("productCategory").textContent =
            listing.category || "General";

          // Populate price
          const priceText = listing.price
            ? `$${parseFloat(listing.price).toFixed(2)}`
            : "Contact for price";
          document.getElementById("productPrice").textContent = priceText;
          document.getElementById("productPriceMobile").textContent = priceText;

          // Populate unit
          if (listing.unit) {
            document.getElementById(
              "priceUnit"
            ).textContent = `/${listing.unit}`;
            document.getElementById(
              "priceUnitMobile"
            ).textContent = `/${listing.unit}`;
            document.getElementById("productUnit").textContent = listing.unit;
            document.getElementById("unitRow").style.display = "flex";
          }

          // Populate MOQ
          if (listing.minOrder) {
            const moqText = `Min. Order: ${listing.minOrder} ${
              listing.unit || "units"
            }`;
            document.getElementById("moqBox").textContent = moqText;
            document.getElementById("moqMobile").textContent = moqText;
            document.getElementById("productMOQ").textContent = `${
              listing.minOrder
            } ${listing.unit || "units"}`;
            document.getElementById("moqRow").style.display = "flex";
          }

          // Populate stock
          if (listing.stock) {
            const stockStatus = listing.stock > 0 ? "In Stock" : "Out of Stock";
            document.getElementById("stockStatus").textContent = stockStatus;
            document.getElementById("stockStatus").style.color =
              listing.stock > 0 ? "#007600" : "#B12704";
            document.getElementById(
              "productStock"
            ).textContent = `${listing.stock} units`;
            document.getElementById("stockRow").style.display = "flex";
          }

          // Populate seller name and link to store
          const sellerNameEl = document.getElementById("sellerName");
          sellerNameEl.textContent =
            listing.storeName || listing.author || "Anonymous Seller";

          // Make seller name clickable if it's a seller listing
          if (listing.role === "seller" && listing.userId) {
            sellerNameEl.href = `/store.html?userId=${listing.userId}`;
          } else {
            sellerNameEl.style.cursor = "default";
            sellerNameEl.style.textDecoration = "none";
            sellerNameEl.onclick = (e) => e.preventDefault();
          }

          // Update contact button text based on poster role
          const contactBtn = document.getElementById("contactBtn");
          if (listing.role === "buyer") {
            contactBtn.textContent = "Contact Buyer";
          } else {
            contactBtn.textContent = "Contact Seller";
          }

          // Show edit/delete buttons if user owns this listing
          const actionsDiv = document.getElementById("buyBoxActions");
          if (isOwner) {
            actionsDiv.innerHTML = `
              <button class="buy-box-btn secondary" onclick="editListing()">Edit Listing</button>
              <button class="buy-box-btn" onclick="deleteListing()" style="background: #B12704; color: #fff; border-color: #B12704;">Delete Listing</button>
            `;
          } else if (user && user.id) {
            // Only show contact button if user is logged in and not the owner
            contactBtn.style.display = "inline-block";

            // For buyers viewing seller listings, allow contact
            // For sellers viewing buyer requirements, allow contact only if conversation exists
            if (user.role === "buyer" && listing.role === "seller") {
              contactBtn.onclick = () => contactSeller(listing);

              // Show wishlist button for buyers viewing seller products
              const wishlistBtn = document.getElementById("wishlistBtn");
              wishlistBtn.style.display = "block";
              wishlistBtn.onclick = toggleWishlist;

              // Check if already in wishlist
              checkWishlistStatus(user.id, listing.id);
            } else if (user.role === "seller" && listing.role === "buyer") {
              contactBtn.onclick = () => contactBuyer(listing);
            }
          } else {
            // Not logged in - prompt to sign in
            contactBtn.onclick = () => {
              alert("Please sign in to contact the seller");
              window.location.href = "/login.html";
            };
          }

          // Show tags if available
          if (listing.tags && listing.tags.length > 0) {
            document.getElementById("listingTagsSection").style.display =
              "block";
            const tagsContainer = document.getElementById("listingTags");
            tagsContainer.innerHTML = "";
            listing.tags.forEach((tag) => {
              const tagEl = document.createElement("span");
              tagEl.className = "tag-item";
              tagEl.textContent = tag;
              tagsContainer.appendChild(tagEl);
            });
          }

          // Show images - handle multiple images
          const productImg = document.getElementById("productImage");
          const thumbnailsContainer =
            document.getElementById("imageThumbnails");

          let images = [];
          if (listing.images) {
            try {
              images = JSON.parse(listing.images);
            } catch (e) {
              images = [];
            }
          }

          // Fallback to single imageUrl if no images array
          if (images.length === 0 && listing.imageUrl) {
            images = [listing.imageUrl];
          }

          if (images.length === 0) {
            images = ["/placeholder-product.jpg"];
          }

          // Set main image to first image
          productImg.src = images[0];
          productImg.alt = listing.title;

          // Create thumbnails
          thumbnailsContainer.innerHTML = "";
          images.forEach((imgUrl, index) => {
            const thumb = document.createElement("img");
            thumb.src = imgUrl;
            thumb.className = "thumbnail" + (index === 0 ? " active" : "");
            thumb.alt = `${listing.title} - Image ${index + 1}`;
            thumb.onclick = () => {
              productImg.src = imgUrl;
              // Update active thumbnail
              document
                .querySelectorAll(".thumbnail")
                .forEach((t) => t.classList.remove("active"));
              thumb.classList.add("active");
            };
            thumbnailsContainer.appendChild(thumb);
          });

          // Load reviews
          loadReviews();
          loadReviewStats();

          // Show mobile price section on small screens
          if (window.innerWidth <= 1024) {
            document.getElementById("priceSectionMobile").style.display =
              "block";
          }

          // Show review form for logged-in buyers
          if (user && user.id && user.role === "buyer" && !isOwner) {
            document.getElementById("reviewFormSection").style.display =
              "block";
            initStarRating();
          }
        } catch (err) {
          console.error("Error loading listing:", err);
          alert("Error loading listing details.");
        }
      }

      // Star rating input functionality
      let selectedRating = 0;
      function initStarRating() {
        const stars = document.querySelectorAll(".star-input");
        stars.forEach((star) => {
          star.addEventListener("click", function () {
            selectedRating = parseInt(this.dataset.rating);
            updateStarDisplay(selectedRating);
          });
          star.addEventListener("mouseenter", function () {
            updateStarDisplay(parseInt(this.dataset.rating));
          });
        });

        document
          .getElementById("starRatingInput")
          .addEventListener("mouseleave", function () {
            updateStarDisplay(selectedRating);
          });
      }

      function updateStarDisplay(rating) {
        const stars = document.querySelectorAll(".star-input");
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add("active");
          } else {
            star.classList.remove("active");
          }
        });
      }

      // Load reviews
      async function loadReviews() {
        try {
          const res = await fetch(`/api/reviews/${listingId}`);
          const reviews = await res.json();

          const reviewsList = document.getElementById("reviewsList");
          reviewsList.innerHTML = "";

          if (reviews.length === 0) {
            reviewsList.innerHTML =
              '<p style="color: #565959; padding: 20px 0;">No reviews yet. Be the first to review this product!</p>';
            return;
          }

          reviews.forEach((review) => {
            const reviewItem = document.createElement("div");
            reviewItem.className = "review-item";

            const initial = (review.userName || "A").charAt(0).toUpperCase();
            const stars =
              "â˜…".repeat(review.rating) + "â˜†".repeat(5 - review.rating);
            const date = new Date(review.createdAt).toLocaleDateString(
              "en-US",
              { year: "numeric", month: "long", day: "numeric" }
            );

            const user = JSON.parse(
              localStorage.getItem("spicetrade_user") || "null"
            );
            const deleteBtn =
              user && user.id === review.userId
                ? `<button class="review-action-btn" onclick="deleteReview(${review.id})">Delete</button>`
                : "";

            reviewItem.innerHTML = `
              <div class="review-header">
                <div class="reviewer-avatar">${initial}</div>
                <div class="reviewer-info">
                  <div class="reviewer-name">${
                    review.userName || "Anonymous"
                  }</div>
                  <div class="review-date">${date}</div>
                </div>
              </div>
              <div class="review-stars">${stars}</div>
              <div class="review-text">${review.reviewText || ""}</div>
              <div class="review-actions">
                ${deleteBtn}
              </div>
            `;

            reviewsList.appendChild(reviewItem);
          });
        } catch (err) {
          console.error("Error loading reviews:", err);
        }
      }

      // Load review statistics
      async function loadReviewStats() {
        try {
          const res = await fetch(`/api/reviews/stats/${listingId}`);
          const stats = await res.json();

          document.getElementById("avgRating").textContent =
            stats.averageRating || "0";
          document.getElementById("totalRatings").textContent = `${
            stats.totalReviews
          } ${stats.totalReviews === 1 ? "rating" : "ratings"}`;

          // Update stars display
          const fullStars = Math.floor(stats.averageRating);
          const starsHtml = "â˜…".repeat(fullStars) + "â˜†".repeat(5 - fullStars);
          document.getElementById("avgStars").textContent = starsHtml;

          // Update rating count in header
          document.getElementById(
            "ratingCount"
          ).textContent = `${stats.totalReviews} ratings`;

          // Update rating bars
          const total = stats.totalReviews || 1;
          document.getElementById("bar5").style.width = `${
            (stats.fiveStars / total) * 100
          }%`;
          document.getElementById("bar4").style.width = `${
            (stats.fourStars / total) * 100
          }%`;
          document.getElementById("bar3").style.width = `${
            (stats.threeStars / total) * 100
          }%`;
          document.getElementById("bar2").style.width = `${
            (stats.twoStars / total) * 100
          }%`;
          document.getElementById("bar1").style.width = `${
            (stats.oneStar / total) * 100
          }%`;

          document.getElementById("count5").textContent = stats.fiveStars;
          document.getElementById("count4").textContent = stats.fourStars;
          document.getElementById("count3").textContent = stats.threeStars;
          document.getElementById("count2").textContent = stats.twoStars;
          document.getElementById("count1").textContent = stats.oneStar;
        } catch (err) {
          console.error("Error loading review stats:", err);
        }
      }

      // Submit review
      async function submitReview() {
        const user = JSON.parse(
          localStorage.getItem("spicetrade_user") || "null"
        );
        if (!user || !user.id) {
          alert("Please sign in to write a review");
          window.location.href = "/login.html";
          return;
        }

        if (selectedRating === 0) {
          alert("Please select a star rating");
          return;
        }

        const reviewText = document.getElementById("reviewText").value.trim();

        try {
          const res = await fetch("/api/reviews", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              adId: parseInt(listingId),
              userId: user.id,
              rating: selectedRating,
              reviewText: reviewText,
            }),
          });

          const data = await res.json();

          if (data.success) {
            alert("Review submitted successfully!");
            selectedRating = 0;
            document.getElementById("reviewText").value = "";
            updateStarDisplay(0);
            loadReviews();
            loadReviewStats();
          } else {
            alert(data.message || "Failed to submit review");
          }
        } catch (err) {
          console.error("Error submitting review:", err);
          alert("Error submitting review");
        }
      }

      // Delete review
      async function deleteReview(reviewId) {
        if (!confirm("Are you sure you want to delete this review?")) {
          return;
        }

        try {
          const res = await fetch(`/api/reviews/${reviewId}`, {
            method: "DELETE",
          });

          const data = await res.json();

          if (data.success) {
            alert("Review deleted successfully");
            loadReviews();
            loadReviewStats();
            document.getElementById("reviewFormSection").style.display =
              "block";
          } else {
            alert("Failed to delete review");
          }
        } catch (err) {
          console.error("Error deleting review:", err);
          alert("Error deleting review");
        }
      }

      // Handle window resize for responsive price display
      window.addEventListener("resize", () => {
        const mobileSection = document.getElementById("priceSectionMobile");
        if (window.innerWidth <= 1024) {
          mobileSection.style.display = "block";
        } else {
          mobileSection.style.display = "none";
        }
      });

      async function contactSeller(listing) {
        // Buyer contacting seller
        const user = JSON.parse(
          localStorage.getItem("spicetrade_user") || "null"
        );

        if (!user || !user.id) {
          alert("Please sign in to contact the seller");
          window.location.href = "/login.html";
          return;
        }

        try {
          // Start or get existing conversation
          const res = await fetch("/api/conversations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              buyerId: user.id,
              sellerId: listing.userId,
              listingId: listing.id,
            }),
          });

          const result = await res.json();

          if (result.success) {
            // Redirect to messages page
            window.location.href = `/messages.html?conversation=${result.conversationId}`;
          } else {
            alert("Failed to start conversation");
          }
        } catch (err) {
          console.error("Error starting conversation:", err);
          alert("Failed to start conversation");
        }
      }

      async function contactBuyer(listing) {
        // Seller contacting buyer (only if conversation already exists)
        const user = JSON.parse(
          localStorage.getItem("spicetrade_user") || "null"
        );

        if (!user || !user.id) {
          alert("Please sign in to contact the buyer");
          window.location.href = "/login.html";
          return;
        }

        try {
          // Check if conversation exists (buyer must have initiated)
          const res = await fetch(`/api/conversations/${user.id}`);
          const conversations = await res.json();

          const existingConv = conversations.find(
            (c) => c.buyerId === listing.userId && c.sellerId === user.id
          );

          if (existingConv) {
            // Conversation exists, go to messages
            window.location.href = `/messages.html?conversation=${existingConv.id}`;
          } else {
            // No existing conversation - seller cannot initiate
            alert(
              "You can only respond to messages from buyers. Wait for the buyer to contact you first."
            );
          }
        } catch (err) {
          console.error("Error checking conversation:", err);
          alert("Failed to check conversation");
        }
      }

      function editListing() {
        alert("Edit feature coming soon! You can delete and recreate for now.");
      }

      async function deleteListing() {
        if (!confirm("Are you sure you want to delete this listing?")) {
          return;
        }

        try {
          const res = await fetch(`/api/ads/${listingId}`, {
            method: "DELETE",
          });
          const data = await res.json();

          if (data.success) {
            alert("Listing deleted successfully!");
            location.href = "/";
          } else {
            alert(data.error || "Failed to delete listing");
          }
        } catch (err) {
          console.error("Error deleting listing:", err);
          alert("Error deleting listing");
        }
      }

      let currentWishlistId = null;

      async function checkWishlistStatus(userId, adId) {
        try {
          const res = await fetch("/api/wishlist/check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, adId }),
          });
          const data = await res.json();

          const wishlistBtn = document.getElementById("wishlistBtn");
          if (data.inWishlist) {
            wishlistBtn.textContent = "â™¥ Remove from Wishlist";
            wishlistBtn.style.background = "#FFF3E0";
            wishlistBtn.style.borderColor = "#FFA41C";
            wishlistBtn.style.color = "#C45500";
            currentWishlistId = data.wishlistId;
          } else {
            wishlistBtn.textContent = "â™¡ Add to Wishlist";
            wishlistBtn.style.background = "#fff";
            wishlistBtn.style.borderColor = "#D5D9D9";
            wishlistBtn.style.color = "#0F1111";
            currentWishlistId = null;
          }
        } catch (err) {
          console.error("Error checking wishlist:", err);
        }
      }

      async function toggleWishlist() {
        const user = JSON.parse(
          localStorage.getItem("spicetrade_user") || "null"
        );
        if (!user || !user.id) {
          alert("Please sign in to use wishlist");
          window.location.href = "/login.html";
          return;
        }

        const wishlistBtn = document.getElementById("wishlistBtn");
        wishlistBtn.disabled = true;

        try {
          if (currentWishlistId) {
            // Remove from wishlist
            const res = await fetch(`/api/wishlist/${currentWishlistId}`, {
              method: "DELETE",
            });
            const data = await res.json();

            if (data.success) {
              wishlistBtn.textContent = "â™¡ Add to Wishlist";
              wishlistBtn.style.background = "#fff";
              wishlistBtn.style.borderColor = "#D5D9D9";
              wishlistBtn.style.color = "#0F1111";
              currentWishlistId = null;
            } else {
              alert("Failed to remove from wishlist");
            }
          } else {
            // Add to wishlist
            const res = await fetch("/api/wishlist", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId: user.id,
                adId: parseInt(listingId),
              }),
            });
            const data = await res.json();

            if (data.success) {
              wishlistBtn.textContent = "â™¥ Remove from Wishlist";
              wishlistBtn.style.background = "#FFF3E0";
              wishlistBtn.style.borderColor = "#FFA41C";
              wishlistBtn.style.color = "#C45500";
              currentWishlistId = data.wishlistId;
            } else {
              alert(data.message || "Failed to add to wishlist");
            }
          }
        } catch (err) {
          console.error("Error toggling wishlist:", err);
          alert("Failed to update wishlist");
        } finally {
          wishlistBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
